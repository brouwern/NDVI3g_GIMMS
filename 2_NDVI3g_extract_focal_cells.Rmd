---
title: "Extract focal NDVI3d cells"
author: "brouwern@gmail.com"
date: "July 5, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

* Load processed rasters of the Pedernales area  
* Identify cells within the raster that correspond the study sites
* Create a time series of values for each year of study

## Libraries
```{r}
library(ggplot2)
library(GGally)
library(reshape2)
library(raster)
library(lubridate)
library(plyr)
```



##  Load data

Load rasters
```{r}
load("./data/data_out/NDVI_pedernales_1993_2015.RData")
```



Load spatial points for 
```{r}
load("./data/data_in/pedernales_spatial_points.RData")
```


Look at spatial points data
```{r}
spdf.all@data
```



## Align spatial points to raster

```{r}
p.all <- spTransform(spdf.all,
                     crs(ndvi.list.stacked[[1]]))
```

Check

```{r}
plot(ndvi.list.stacked[[1]][[1]])
plot(p.all, add = TRUE)
```



## Identify cell that a point lies within
gis.stackexchange.com/questions/174925/how-to-find-the-cell-location-index-of-a-raster-using-lat-long-information



Get cell numbers
```{r}
# get cell number
##thorn-scrub site site 
id.scrub <- extract(ndvi.list.stacked[[1]],
                   SpatialPoints(cbind(p.all@data[1,2],
                                       p.all@data[1,1])), 
                   cellnumbers=TRUE)[1]

##broadleaf forest
id.bl <- extract(ndvi.list.stacked[[1]],
                   SpatialPoints(cbind(p.all@data[3,2],
                                       p.all@data[3,1])), 
                   cellnumbers=TRUE)[1]


## Lloyds site (Lloyd et al 2015 PeerJ)
id.Lloyd<- extract(ndvi.list.stacked[[1]],
                   SpatialPoints(cbind(p.all@data[8,2],
                                       p.all@data[8,1])), 
                   cellnumbers=TRUE)[1]



```


Get rows x column location
```{r}
row.col.scrub <- rowColFromCell(ndvi.list.stacked[[1]],
               id.scrub)

row.col.bl <- rowColFromCell(ndvi.list.stacked[[1]],
               id.bl)


row.col.Lloyd <- rowColFromCell(ndvi.list.stacked[[1]],
               id.Lloyd)
```




# Visualize cell locations
Function to visualize selected cells
```{r}
plot.cell <- function(rast, row.col, color = 2){
  plot(extent(rast, 
            row.col[1], row.col[1], 
            row.col[2],  row.col[2]), 
     add=TRUE, col=color, lwd=3)
}
```


Plot selected cells
```{r}
plot.cell(rast = ndvi.list.stacked[[1]],
          row.col = row.col.scrub)
plot.cell(rast = ndvi.list.stacked[[1]],
          row.col = row.col.bl,
          color = 3)
plot.cell(rast = ndvi.list.stacked[[1]],
          row.col = row.col.Lloyd,
          color = 4)
```





# Build time series

Get meta data for each layer
```{r}
#get names of each layr
layer.names <- names(ndvi.list.stacked)

#extrat year month etc
yr <- gsub(".*([21][01-9][01-9][01-9]).*","\\1",layer.names)
mo.num <- gsub(".*([_])([1]{0,1}[01-9])([ab])","\\2",layer.names)
mo.ab <- gsub(".*([_])([1]{0,1}[01-9])([ab])","\\3",layer.names)


```


Extract data values from stacked data; "ts" is for "time series"
```{r}
ts.scrub = as.vector(ndvi.list.stacked[row.col.scrub])
ts.bl = as.vector(ndvi.list.stacked[row.col.bl])
ts.Lloyd = as.vector(ndvi.list.stacked[row.col.Lloyd])

```


Put data from selected cells into into dataframes
```{r}
dat.scrub <- data.frame(NDVI = ts.scrub,
                        yr = yr,
                        mo.num = mo.num,
                        mo.ab = mo.ab,
                        site = "scrub",
                        stringsAsFactors = F,
                        i = 1:length(ts.scrub))

dat.broadleaf <- data.frame(NDVI = ts.bl,
                        yr = yr,
                        mo.num = mo.num,
                        mo.ab = mo.ab,
                        site = "broadleaf",
                        stringsAsFactors = F,
                        i = 1:length(ts.bl))


dat.Lloyd <- data.frame(NDVI = ts.Lloyd,
                        yr = yr,
                        mo.num = mo.num,
                        mo.ab = mo.ab,
                        stringsAsFactors = F,
                        site = "Lloyd",
                        i = 1:length(ts.Lloyd))

#stack dataframes
dat <- rbind(dat.scrub,
             dat.broadleaf,
             dat.Lloyd)




```




Convert "a" vs "b" month designation to 0.5 for convience
```{r}
dat$mo.num2 <- as.numeric(dat$mo.num) + ifelse(dat$mo.ab == "a",0,0.5)

y.max <- max(dat$NDVI)
y.min <- min(dat$NDVI)

qplot(y = NDVI,
      x = i,
      data = dat,
      color = site,
      geom = "line")
```



# Add NAs for any missing data

If data hasn't been retrieved from web or a file was corrupted, this will add NAs for those years
```{r}
rng <- range(as.numeric(dat$yr))

dat.dummy <- expand.grid(yr = rng[1]:rng[2],
                         mo.num = 1:12,
                         mo.ab = c("a","b"),
                         site = c("scrub","broadleaf","Lloyd"),
                         stringsAsFactors = F)
dat.dummy$mo.num2 <- as.numeric(dat.dummy$mo.num) + ifelse(dat.dummy$mo.ab == "a",0,0.5)



dat2 <- merge(dat, dat.dummy,all =  T)
dat2$i.new <- 1:dim(dat2)[1]



```



Look at 2004, which had problems downloading (July 2017)
```{r}
i.2004 <- which(dat2$yr == "2004")

dat2[i.2004,]
```




## Designate data based on whether its the 1st or 2nd image in for a month

22nd to 7th = ~15 days
7th to 22nd = 15 days

```{r}
dat2$day.num <- ifelse(dat2$mo.ab == "a",7,22)
```




## Calculate Julian datas


Concatenate date
```{r}
mo. <- ifelse(as.numeric(dat2$mo.num) > 9, 
              dat2$mo.num ,
                paste(0,dat2$mo.num, sep = ""))


date. <-  paste(dat2$yr,
       mo.,
      dat2$day.num,
      sep = "-")


```



## Calculate julian w/in year

yday function is from lubridate
```{r}
dat2$julian <- yday(date.)

```


## Sort by Julian w/in year

arrange() is in plyr

```{r}
dat3 <- arrange(dat2, yr, julian)
```




Month abbreviations
```{r}
dat3$mo.num3 <- month.abb[dat3$mo.num2]
```



# Cumulative date

Calculate date since 1st timepoint in data
```{r}

i.scrub <- which(dat3$site == "scrub")
i.bl <- which(dat3$site == "broadleaf")
i.lloyd <- which(dat3$site == "Lloyd")


dat3$days.elapsed  <- NA

dat3$days.elapsed[i.scrub] <- cumsum(dat3$julian[i.scrub])
dat3$days.elapsed[i.bl] <- cumsum(dat3$julian[i.bl])
dat3$days.elapsed[i.lloyd] <- cumsum(dat3$julian[i.lloyd])

```





## Plot full time series
```{r}
qplot(y = NDVI,
      x = days.elapsed,
      data = dat3[,],
      color = site,
      geom = "line")
```


```{r}
i.scrub <- which(dat3$site == "scrub")
qplot(y = NDVI,
      x = julian,
      data = dat3[,],
      color = site,
      group = yr,
      geom = "smooth",
      se = FALSE) +
  facet_grid(site ~ ., scale = "free") +
  geom_smooth(se = F)
```




## Make dates

```{r}
dat6$date <- with(dat6, 
                  paste(day.num,
                        mo.num,
                        yr,sep = "/"))
```


## Save


Save
```{r}
save(dat6, file = "./data/NDVI_bimonthly_time_series_by_site.RData")
write.csv(dat6, file = "./data/NDVI_bimonthly_time_series_by_site.csv",
          row.names = F)
```

```{r}
load("~/1_R/git/gimms_NDVI_processing/data/NDVI_time_series_by_site.RData")
```






## Summarize by season


Indices for the seasons
```{r}
dat6$mo.num<- as.numeric(dat6$mo.num)

i.win <- which(dat6$mo.num %in% c(1,2,3))#1st dry season
i.spr <- which(dat6$mo.num %in% c(4,5,6))#1st rain season
i.sum <- which(dat6$mo.num %in% c(7,8,9))#2nd dry season
i.fal <- which(dat6$mo.num %in% c(10,11,12))#2nd rainy season
```

```{r}

winter <- dcast(data = dat6[i.win,],
      formula = yr + site +
        nin.phase.strt + nin.str.strt +
        nin.phase.end + nin.str.end ~ .,
      value.var = "NDVI",
      fun.aggregate = mean
        )
names(winter)[dim(winter)[2]] <- "mean.NDVI.win"

spring <- dcast(data = dat6[i.spr,],
      formula = yr + site +
        nin.phase.strt + nin.str.strt +
        nin.phase.end + nin.str.end ~ .,
      value.var = "NDVI",
      fun.aggregate = mean
        )
names(spring)[dim(spring)[2]] <- "mean.NDVI.spr"

summer <- dcast(data = dat6[i.sum,],
      formula = yr + site +
        nin.phase.strt + nin.str.strt +
        nin.phase.end + nin.str.end ~ .,
      value.var = "NDVI",
      fun.aggregate = mean
        )
names(summer)[dim(summer)[2]] <- "mean.NDVI.sum"

fall <- dcast(data = dat6[i.fal,],
      formula = yr + site +
        nin.phase.strt + nin.str.strt +
        nin.phase.end + nin.str.end ~ .,
      value.var = "NDVI",
      fun.aggregate = mean
        )
names(fall)[dim(fall)[2]] <- "mean.NDVI.fall"

year <- dcast(data = dat6[,],
      formula = yr + site +
        nin.phase.strt + nin.str.strt +
        nin.phase.end + nin.str.end ~ .,
      value.var = "NDVI",
      fun.aggregate = mean
        )
names(year)[dim(year)[2]] <- "mean.NDVI.year"

```






```{r}
temp <- merge(winter,spring)
temp <- merge(temp, summer)
temp <- merge(temp, fall)
dat7 <- merge(temp, year)
```



## Pairs plot

```{r}
i.scrub <- with(dat7, which(site == "scrub"))
ggpairs(dat7[-i.scrub,],
        columns = c("mean.NDVI.spr","mean.NDVI.sum",
                    "mean.NDVI.fall","mean.NDVI.year",
                    "mean.NDVI.win"),
        diag = NULL,
        mapping = aes(color = nin.phase.strt))
```



## Save summaries
```{r}
write.csv(dat7,file = "./data/NDVI_annual_summaries_1993_2015.csv",
          row.names = FALSE)
```








## Set up time lag

```{r}
dat7.lag <- dat7[,c("yr","site",
                    "mean.NDVI.win","mean.NDVI.spr",
                    "mean.NDVI.sum","mean.NDVI.fall",
                    "mean.NDVI.year")]

dat7.lag$yr.orig <- dat7.lag$yr

dat7.lag$yr <- dat7.lag$yr + 1


names(dat7.lag)[-c(1:2)] <- paste("lag",
                                   names(dat7.lag)[-c(1:2)], 
                                   sep = ".")
```


## Merge lagged w/ orig

```{r}

dat8 <- merge(dat7, dat7.lag)


dim(dat7)
dim(dat8)
```






## Save summaries
```{r}
write.csv(dat8,
          file = "./data/NDVI_annual_summaries_1993_2015.csv",
          row.names = FALSE)
```



















## Mean NDVi for month

```{r}
dat3 <- dcast(data = na.omit(dat2),
              formula = yr + mo.num + site ~ .,
              value.var = "NDVI",
              fun.aggregate = mean)

names(dat3)[4] <- "mean.mo.NDVI"

dat3$mo.num <- as.numeric(dat3$mo.num)

qplot(y = mean.mo.NDVI,
      x = mo.num,
      color = site,
      data = dat3)


```


ean NDVi for year

```{r}
dat4 <- dcast(data = na.omit(dat2),
              formula = yr +  site ~ mo.num,
              value.var = "NDVI",
              fun.aggregate = sum)

names(dat4)[3] <- "mean.ann.NDVI"

dat4$mean.ann.NDVI <- apply(dat4[,4:6],1,sum)


qplot(y = mean.ann.NDVI,
      x = site,
      data = dat4,
      geom = "boxplot")


```



```{r}
names(dat4)
dat4$yr <-  as.numeric(dat4$yr) +1

names(tot.caps.by.hab)
status.caps$habitat <- gsub("desert","scrub",status.caps$habitat)
names(status.caps)[3] <- "site"


x <- merge(dat4,status.caps)

qplot(y = N.tot,
      x = log(mean.ann.NDVI), 
      data = x, 
      shape = status,
      color = site) +
  facet_grid(status ~ site, scale = "free") +
  geom_smooth(method = "lm")

plot(NDVI ~ N.tot, data = x)

tot.caps.by.hab

```





```{r}
names(dat3)
names(rain.sum.ped)

names(rain.sum.ped) <- gsub("year","yr",names(rain.sum.ped))

rain.sum.ped.lagged <- rain.sum.ped

dat3$mo.num
rain.sum.ped.lagged$mo.num <- rain.sum.ped$mo.num-1



m <- merge(x = dat3,
           y = rain.sum.ped.lagged)

qplot(y = mean.mo.NDVI,
      x = mo.num,
       data = m, 
      color =site) 

qplot(y = rain.sum,
      x = mo.num,
       data = m, 
      color =site)

qplot(y = mean.mo.NDVI,
      x = rain.sum,
       data = m, 
      color =site) +
  facet_wrap(~mo,scales = "free")

```




```{r}
ts(ndvi.1997.0106[row.col.scrub]
```













```{r}
ndvi.1997.0106.crop <- crop(ndvi.1997.0106,e)
ndvi.1997.0712.crop <- crop(ndvi.1997.0712,e)
plot(ndvi.1997.0106.crop[[1]])
```

```{r}
ndvis.1997.crop.all <- stack(ndvi.1997.0106.crop,
                            ndvi.1997.0712.crop )
```



